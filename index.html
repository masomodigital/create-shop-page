<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Masomo Shopkeeper Portal</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background-color: #f9f9f9; }
    h2 { color: #2a5d84; }
    input, textarea, button { padding: 8px; margin: 5px 0; width: 100%; box-sizing: border-box; font-size: 16px; }
    button { cursor: pointer; background-color: #2a5d84; color: #fff; border: none; border-radius: 5px; }
    button:hover { background-color: #1f4564; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    table, th, td { border: 1px solid #ddd; }
    th, td { padding: 8px; text-align: left; }
    .hidden { display: none; }
    .inline-input { width: 90%; font-size: 16px; padding: 6px; }
    .error { color: red; }
    .success { color: green; font-weight: bold; }

    /* Mobile adjustments */
    @media (max-width: 600px) {
      input, textarea, button, .inline-input { font-size: 18px; padding: 10px; }
      table, th, td { font-size: 16px; }
    }

    /* Bottom button container */
    .bottom-buttons {
      margin-top: 30px;
      text-align: center;
      display: flex;
      justify-content: center;
      gap: 15px;
      flex-wrap: wrap;
    }

    .bottom-buttons a, .bottom-buttons button {
      padding: 8px 15px;
      border-radius: 5px;
      font-weight: bold;
      text-decoration: none;
      cursor: pointer;
    }

    .visit-btn { background-color: #28a745; color: white; }
    .visit-btn:hover { background-color: #218838; }

    .logout-btn { background-color: red; color: white; }
    .logout-btn:hover { background-color: #cc0000; }

  </style>
</head>
<body>
  <!-- Login Form -->
  <div id="loginDiv">
    <h2>MY BUSINESS ADVERTISEMENT</h2>
    <ul style="margin-left: 20px; line-height: 1.6;">
      <li>Masomo SMS App enables you to effectively advertise your business.</li>
      <li>Login and enter your shop details: name, description, and location.</li>
      <li>Input your TOP products and services along with their prices.</li>
      <li>Customers can click on your listings and be redirected directly to WhatsApp to contact you.</li>
      <li>Whenever you sell airtime, an SMS with a link to your shop page is automatically sent to the customer.</li>
      <li>This means Masomo SMS App actively helps advertise your business and boost your sales.</li>
    </ul>

    <label for="nationalId">National ID / User ID</label>
    <input type="text" id="nationalId" placeholder="Enter National ID" required>
    <label for="password">Password</label>
    <input type="password" id="password" placeholder="Enter Password" required>
    <button onclick="login()">Login</button>
    <div id="loginMsg"></div>
  </div>

  <!-- Dashboard -->
  <div id="dashboardDiv" class="hidden">
    <h2 id="welcomeMsg">Welcome </h2>
    
    <!-- Shop Profile -->
    <h3>SHOP PROFILE</h3>
    <label style="color: green; display: inline-block; width: 140px;">Shop Name</label>
<input type="text" id="shopName">

<label style="color: green; display: inline-block; width: 140px;">Owner Name</label>
<input type="text" id="ownerName" readonly>

<label style="color: green; display: inline-block; width: 140px;">Phone</label>
<input type="text" id="phone" readonly>

<label style="color: green; display: inline-block; width: 140px;">WhatsApp Number</label>
<input type="text" id="whatsapp">

<label style="color: green; display: inline-block; width: 140px;">Location</label>
<input type="text" id="location">

<label style="color: green; display: inline-block; width: 140px;">Description</label>
<textarea id="description" rows="3"></textarea>
    <button onclick="saveProfile()">Save Profile</button>
    <div id="profileMsg"></div>

    <!-- Products -->
    <h3>Products / Services (Max 10)</h3>
    <table id="productsTable">
      <thead>
        <tr>
          <th>#</th>
          <th>Item Name</th>
          <th>Description</th>
          <th>Price (KSh.)</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <button onclick="addProduct()">Add New Product</button>
    <div id="productMsg"></div>

    <!-- Bottom Buttons -->
    <div class="bottom-buttons">
      <a href="https://masomodigital.github.io/view-shop-page/" class="visit-btn">VISIT MY WEBPAGE</a>
      <button class="logout-btn" onclick="logout()">LOG OUT</button>
    </div>
  </div>

  <script>
    const WORKER_URL = "https://super-sky-2031.dmaundu02.workers.dev/";
    let currentUser = null;
    let products = [];

    function showMessage(elementId, message, type="success") {
      const el = document.getElementById(elementId);
      el.innerHTML = `<span class='${type}'>${message}</span>`;
      setTimeout(() => { el.innerHTML = ""; }, 3000);
    }

    async function callWorker(payload) {
      try {
        const resp = await fetch(WORKER_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        return await resp.json();
      } catch (err) {
        return { success: false, message: "Network error: " + err.message };
      }
    }

    // ======================
    // LOGIN
    // ======================
    async function login() {
      const nationalId = document.getElementById("nationalId").value.trim();
      const password = document.getElementById("password").value.trim();
      if (!nationalId || !password) return;

      showMessage("loginMsg", "Processing...");

      const resp = await callWorker({ action: "login", nationalId, password });
      if (resp.success) {
        currentUser = resp;
        document.getElementById("loginDiv").classList.add("hidden");
        document.getElementById("dashboardDiv").classList.remove("hidden");
        document.getElementById("welcomeMsg").innerText = "Welcome " + resp.ownerName;
        loadShopProfile();
        loadProducts();
      } else {
        showMessage("loginMsg", resp.message, "error");
      }
    }

    // ======================
    // SHOP PROFILE
    // ======================
    async function loadShopProfile() {
      const profile = await callWorker({ action: "getShopProfile", userId: currentUser.userId });
      document.getElementById("shopName").value = profile.shopName;
      document.getElementById("ownerName").value = currentUser.ownerName;
      document.getElementById("phone").value = currentUser.phone;
      document.getElementById("whatsapp").value = profile.whatsapp;
      document.getElementById("location").value = profile.location;
      document.getElementById("description").value = profile.description;
    }

    async function saveProfile() {
      const profile = {
        userId: currentUser.userId,
        shopName: document.getElementById("shopName").value.trim(),
        ownerName: currentUser.ownerName,
        phone: currentUser.phone,
        whatsapp: document.getElementById("whatsapp").value.trim(),
        location: document.getElementById("location").value.trim(),
        description: document.getElementById("description").value.trim()
      };
      if (!profile.shopName || !profile.location || !profile.description) {
        showMessage("profileMsg", "Please fill all required fields.", "error");
        return;
      }

      showMessage("profileMsg", "Saving...");
      const resp = await callWorker({ action: "saveShopProfile", profile });
      if (resp.success) showMessage("profileMsg", resp.message);
      else showMessage("profileMsg", resp.message, "error");
    }

    // ======================
    // PRODUCTS
    // ======================
    async function loadProducts() {
      products = await callWorker({ action: "getProducts", userId: currentUser.userId });
      renderProducts();
    }

    function renderProducts() {
      const tbody = document.querySelector("#productsTable tbody");
      tbody.innerHTML = "";
      products.forEach(p => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.itemNumber}</td>
          <td><input class="inline-input" type="text" value="${p.itemName}" onchange="updateProduct(${p.itemNumber}, 'itemName', this.value)"></td>
          <td><input class="inline-input" type="text" value="${p.itemDescription}" onchange="updateProduct(${p.itemNumber}, 'itemDescription', this.value)"></td>
          <td><input class="inline-input" type="number" value="${p.price}" onchange="updateProduct(${p.itemNumber}, 'price', this.value)"></td>
          <td><button onclick="deleteProduct(${p.itemNumber})">Delete</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function addProduct() {
      if (products.length >= 10) {
        showMessage("productMsg", "Maximum 10 products allowed.", "error");
        return;
      }
      const nextNumber = products.length + 1;
      const newProduct = { itemNumber: nextNumber, itemName: "", itemDescription: "", price: "" };

      showMessage("productMsg", "Saving...");
      const resp = await callWorker({ action: "saveProduct", userId: currentUser.userId, product: newProduct });
      if (resp.success) {
        products.push(newProduct);
        renderProducts();
      } else {
        showMessage("productMsg", resp.message, "error");
      }
    }

    async function updateProduct(itemNumber, field, value) {
      const prod = products.find(p => p.itemNumber == itemNumber);
      if (!prod) return;
      prod[field] = value;

      showMessage("productMsg", "Saving...");
      await callWorker({ action: "saveProduct", userId: currentUser.userId, product: prod });
    }

    async function deleteProduct(itemNumber) {
      showMessage("productMsg", "Deleting...");
      const resp = await callWorker({ action: "deleteProduct", userId: currentUser.userId, itemNumber });
      if (resp.success) {
        products = products.filter(p => p.itemNumber != itemNumber);
        products.forEach((p, idx) => p.itemNumber = idx + 1);
        renderProducts();
        showMessage("productMsg", resp.message);
      } else {
        showMessage("productMsg", resp.message, "error");
      }
    }

    // ======================
    // LOGOUT
    // ======================
    function logout() {
      currentUser = null;
      products = [];
      document.getElementById("dashboardDiv").classList.add("hidden");
      document.getElementById("loginDiv").classList.remove("hidden");
      document.getElementById("nationalId").value = "";
      document.getElementById("password").value = "";
    }
  </script>
</body>
</html>
